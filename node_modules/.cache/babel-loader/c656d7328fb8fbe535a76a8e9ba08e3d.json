{"ast":null,"code":"const Account = require(\"./account\");\n\nconst Nat = require(\"./nat\");\n\nconst Bytes = require(\"./bytes\");\n\nconst RLP = require(\"./rlp\");\n\nconst keccak256 = require(\"./hash\").keccak256; // EthereumRPC, IncompleteTransaction -> Promise Transaction\n\n\nconst addDefaults = (rpc, tx) => {\n  var baseDefaults = [tx.chainId || rpc(\"net_version\", []), tx.gasPrice || rpc(\"eth_gasPrice\", []), tx.nonce || rpc(\"eth_getTransactionCount\", [tx.from, \"latest\"]), tx.value || \"0x0\", tx.data || \"0x\"];\n\n  const noAddress = address => !address || address === \"\" || address === \"0x\";\n\n  return Promise.all(baseDefaults).then(_ref => {\n    let [chainIdNum, gasPrice, nonce, value, data] = _ref;\n    var chainId = Nat.fromNumber(chainIdNum);\n    var gasEstimator = tx.gas ? Promise.resolve(null) : rpc(\"eth_estimateGas\", [{\n      from: noAddress(tx.from) ? null : tx.from,\n      to: noAddress(tx.to) ? null : tx.to,\n      value: tx.value,\n      nonce: tx.nonce,\n      data: tx.data\n    }]);\n    return gasEstimator.then(gasEstimate => {\n      if (gasEstimate.error) {\n        throw gasEstimate.error;\n      }\n\n      return {\n        chainId: chainId,\n        from: noAddress(tx.from) ? \"0x\" : tx.from.toLowerCase(),\n        to: noAddress(tx.to) ? \"0x\" : tx.to.toLowerCase(),\n        gasPrice: gasPrice,\n        gas: tx.gas ? tx.gas : Nat.div(Nat.mul(gasEstimate, \"0x6\"), \"0x5\"),\n        nonce: nonce,\n        value: value,\n        data: data ? data.toLowerCase() : null\n      };\n    });\n  });\n}; // Transaction -> Bytes\n\n\nconst signingData = tx => {\n  return RLP.encode([Bytes.fromNat(tx.nonce), Bytes.fromNat(tx.gasPrice), Bytes.fromNat(tx.gas), tx.to ? tx.to.toLowerCase() : \"0x\", Bytes.fromNat(tx.value), tx.data, Bytes.fromNat(tx.chainId || \"0x1\"), \"0x\", \"0x\"]);\n}; // Transaction, Account -> Bytes\n\n\nconst sign = (tx, account) => {\n  const data = signingData(tx);\n  const signature = Account.makeSigner(Nat.toNumber(tx.chainId || \"0x1\") * 2 + 35)(keccak256(data), account.privateKey);\n  const rawTransaction = RLP.decode(data).slice(0, 6).concat(Account.decodeSignature(signature));\n  return RLP.encode(rawTransaction);\n}; // Bytes -> Address\n\n\nconst recover = rawTransaction => {\n  const values = RLP.decode(rawTransaction);\n  const signature = Account.encodeSignature(values.slice(6, 9));\n  const recovery = Bytes.toNumber(values[6]);\n  const extraData = recovery < 35 ? [] : [Bytes.fromNumber(recovery - 35 >> 1), \"0x\", \"0x\"];\n  const data = values.slice(0, 6).concat(extraData);\n  const dataHex = RLP.encode(data);\n  return Account.recover(keccak256(dataHex), signature);\n};\n\nmodule.exports = {\n  addDefaults,\n  signingData,\n  sign,\n  recover\n};","map":{"version":3,"names":["Account","require","Nat","Bytes","RLP","keccak256","addDefaults","rpc","tx","baseDefaults","chainId","gasPrice","nonce","from","value","data","noAddress","address","Promise","all","then","chainIdNum","fromNumber","gasEstimator","gas","resolve","to","gasEstimate","error","toLowerCase","div","mul","signingData","encode","fromNat","sign","account","signature","makeSigner","toNumber","privateKey","rawTransaction","decode","slice","concat","decodeSignature","recover","values","encodeSignature","recovery","extraData","dataHex","module","exports"],"sources":["/home/serial/Desktop/code-jam/node_modules/eth-lib/lib/transaction.js"],"sourcesContent":["const Account = require(\"./account\");\nconst Nat = require(\"./nat\");\nconst Bytes = require(\"./bytes\");\nconst RLP = require(\"./rlp\");\nconst keccak256 = require(\"./hash\").keccak256;\n\n// EthereumRPC, IncompleteTransaction -> Promise Transaction\nconst addDefaults = (rpc, tx) => {\n  var baseDefaults = [tx.chainId || rpc(\"net_version\", []), tx.gasPrice || rpc(\"eth_gasPrice\", []), tx.nonce || rpc(\"eth_getTransactionCount\", [tx.from, \"latest\"]), tx.value || \"0x0\", tx.data || \"0x\"];\n  const noAddress = address => !address || address === \"\" || address === \"0x\";\n  return Promise.all(baseDefaults).then(([chainIdNum, gasPrice, nonce, value, data]) => {\n    var chainId = Nat.fromNumber(chainIdNum);\n    var gasEstimator = tx.gas ? Promise.resolve(null) : rpc(\"eth_estimateGas\", [{\n      from: noAddress(tx.from) ? null : tx.from,\n      to: noAddress(tx.to) ? null : tx.to,\n      value: tx.value,\n      nonce: tx.nonce,\n      data: tx.data\n    }]);\n    return gasEstimator.then(gasEstimate => {\n      if (gasEstimate.error) {\n        throw gasEstimate.error;\n      }\n      return {\n        chainId: chainId,\n        from: noAddress(tx.from) ? \"0x\" : tx.from.toLowerCase(),\n        to: noAddress(tx.to) ? \"0x\" : tx.to.toLowerCase(),\n        gasPrice: gasPrice,\n        gas: tx.gas ? tx.gas : Nat.div(Nat.mul(gasEstimate, \"0x6\"), \"0x5\"),\n        nonce: nonce,\n        value: value,\n        data: data ? data.toLowerCase() : null\n      };\n    });\n  });\n};\n\n// Transaction -> Bytes\nconst signingData = tx => {\n  return RLP.encode([Bytes.fromNat(tx.nonce), Bytes.fromNat(tx.gasPrice), Bytes.fromNat(tx.gas), tx.to ? tx.to.toLowerCase() : \"0x\", Bytes.fromNat(tx.value), tx.data, Bytes.fromNat(tx.chainId || \"0x1\"), \"0x\", \"0x\"]);\n};\n\n// Transaction, Account -> Bytes\nconst sign = (tx, account) => {\n  const data = signingData(tx);\n  const signature = Account.makeSigner(Nat.toNumber(tx.chainId || \"0x1\") * 2 + 35)(keccak256(data), account.privateKey);\n  const rawTransaction = RLP.decode(data).slice(0, 6).concat(Account.decodeSignature(signature));\n  return RLP.encode(rawTransaction);\n};\n\n// Bytes -> Address\nconst recover = rawTransaction => {\n  const values = RLP.decode(rawTransaction);\n  const signature = Account.encodeSignature(values.slice(6, 9));\n  const recovery = Bytes.toNumber(values[6]);\n  const extraData = recovery < 35 ? [] : [Bytes.fromNumber(recovery - 35 >> 1), \"0x\", \"0x\"];\n  const data = values.slice(0, 6).concat(extraData);\n  const dataHex = RLP.encode(data);\n  return Account.recover(keccak256(dataHex), signature);\n};\n\nmodule.exports = {\n  addDefaults,\n  signingData,\n  sign,\n  recover\n};"],"mappings":"AAAA,MAAMA,OAAO,GAAGC,OAAO,CAAC,WAAD,CAAvB;;AACA,MAAMC,GAAG,GAAGD,OAAO,CAAC,OAAD,CAAnB;;AACA,MAAME,KAAK,GAAGF,OAAO,CAAC,SAAD,CAArB;;AACA,MAAMG,GAAG,GAAGH,OAAO,CAAC,OAAD,CAAnB;;AACA,MAAMI,SAAS,GAAGJ,OAAO,CAAC,QAAD,CAAP,CAAkBI,SAApC,C,CAEA;;;AACA,MAAMC,WAAW,GAAG,CAACC,GAAD,EAAMC,EAAN,KAAa;EAC/B,IAAIC,YAAY,GAAG,CAACD,EAAE,CAACE,OAAH,IAAcH,GAAG,CAAC,aAAD,EAAgB,EAAhB,CAAlB,EAAuCC,EAAE,CAACG,QAAH,IAAeJ,GAAG,CAAC,cAAD,EAAiB,EAAjB,CAAzD,EAA+EC,EAAE,CAACI,KAAH,IAAYL,GAAG,CAAC,yBAAD,EAA4B,CAACC,EAAE,CAACK,IAAJ,EAAU,QAAV,CAA5B,CAA9F,EAAgJL,EAAE,CAACM,KAAH,IAAY,KAA5J,EAAmKN,EAAE,CAACO,IAAH,IAAW,IAA9K,CAAnB;;EACA,MAAMC,SAAS,GAAGC,OAAO,IAAI,CAACA,OAAD,IAAYA,OAAO,KAAK,EAAxB,IAA8BA,OAAO,KAAK,IAAvE;;EACA,OAAOC,OAAO,CAACC,GAAR,CAAYV,YAAZ,EAA0BW,IAA1B,CAA+B,QAAgD;IAAA,IAA/C,CAACC,UAAD,EAAaV,QAAb,EAAuBC,KAAvB,EAA8BE,KAA9B,EAAqCC,IAArC,CAA+C;IACpF,IAAIL,OAAO,GAAGR,GAAG,CAACoB,UAAJ,CAAeD,UAAf,CAAd;IACA,IAAIE,YAAY,GAAGf,EAAE,CAACgB,GAAH,GAASN,OAAO,CAACO,OAAR,CAAgB,IAAhB,CAAT,GAAiClB,GAAG,CAAC,iBAAD,EAAoB,CAAC;MAC1EM,IAAI,EAAEG,SAAS,CAACR,EAAE,CAACK,IAAJ,CAAT,GAAqB,IAArB,GAA4BL,EAAE,CAACK,IADqC;MAE1Ea,EAAE,EAAEV,SAAS,CAACR,EAAE,CAACkB,EAAJ,CAAT,GAAmB,IAAnB,GAA0BlB,EAAE,CAACkB,EAFyC;MAG1EZ,KAAK,EAAEN,EAAE,CAACM,KAHgE;MAI1EF,KAAK,EAAEJ,EAAE,CAACI,KAJgE;MAK1EG,IAAI,EAAEP,EAAE,CAACO;IALiE,CAAD,CAApB,CAAvD;IAOA,OAAOQ,YAAY,CAACH,IAAb,CAAkBO,WAAW,IAAI;MACtC,IAAIA,WAAW,CAACC,KAAhB,EAAuB;QACrB,MAAMD,WAAW,CAACC,KAAlB;MACD;;MACD,OAAO;QACLlB,OAAO,EAAEA,OADJ;QAELG,IAAI,EAAEG,SAAS,CAACR,EAAE,CAACK,IAAJ,CAAT,GAAqB,IAArB,GAA4BL,EAAE,CAACK,IAAH,CAAQgB,WAAR,EAF7B;QAGLH,EAAE,EAAEV,SAAS,CAACR,EAAE,CAACkB,EAAJ,CAAT,GAAmB,IAAnB,GAA0BlB,EAAE,CAACkB,EAAH,CAAMG,WAAN,EAHzB;QAILlB,QAAQ,EAAEA,QAJL;QAKLa,GAAG,EAAEhB,EAAE,CAACgB,GAAH,GAAShB,EAAE,CAACgB,GAAZ,GAAkBtB,GAAG,CAAC4B,GAAJ,CAAQ5B,GAAG,CAAC6B,GAAJ,CAAQJ,WAAR,EAAqB,KAArB,CAAR,EAAqC,KAArC,CALlB;QAMLf,KAAK,EAAEA,KANF;QAOLE,KAAK,EAAEA,KAPF;QAQLC,IAAI,EAAEA,IAAI,GAAGA,IAAI,CAACc,WAAL,EAAH,GAAwB;MAR7B,CAAP;IAUD,CAdM,CAAP;EAeD,CAxBM,CAAP;AAyBD,CA5BD,C,CA8BA;;;AACA,MAAMG,WAAW,GAAGxB,EAAE,IAAI;EACxB,OAAOJ,GAAG,CAAC6B,MAAJ,CAAW,CAAC9B,KAAK,CAAC+B,OAAN,CAAc1B,EAAE,CAACI,KAAjB,CAAD,EAA0BT,KAAK,CAAC+B,OAAN,CAAc1B,EAAE,CAACG,QAAjB,CAA1B,EAAsDR,KAAK,CAAC+B,OAAN,CAAc1B,EAAE,CAACgB,GAAjB,CAAtD,EAA6EhB,EAAE,CAACkB,EAAH,GAAQlB,EAAE,CAACkB,EAAH,CAAMG,WAAN,EAAR,GAA8B,IAA3G,EAAiH1B,KAAK,CAAC+B,OAAN,CAAc1B,EAAE,CAACM,KAAjB,CAAjH,EAA0IN,EAAE,CAACO,IAA7I,EAAmJZ,KAAK,CAAC+B,OAAN,CAAc1B,EAAE,CAACE,OAAH,IAAc,KAA5B,CAAnJ,EAAuL,IAAvL,EAA6L,IAA7L,CAAX,CAAP;AACD,CAFD,C,CAIA;;;AACA,MAAMyB,IAAI,GAAG,CAAC3B,EAAD,EAAK4B,OAAL,KAAiB;EAC5B,MAAMrB,IAAI,GAAGiB,WAAW,CAACxB,EAAD,CAAxB;EACA,MAAM6B,SAAS,GAAGrC,OAAO,CAACsC,UAAR,CAAmBpC,GAAG,CAACqC,QAAJ,CAAa/B,EAAE,CAACE,OAAH,IAAc,KAA3B,IAAoC,CAApC,GAAwC,EAA3D,EAA+DL,SAAS,CAACU,IAAD,CAAxE,EAAgFqB,OAAO,CAACI,UAAxF,CAAlB;EACA,MAAMC,cAAc,GAAGrC,GAAG,CAACsC,MAAJ,CAAW3B,IAAX,EAAiB4B,KAAjB,CAAuB,CAAvB,EAA0B,CAA1B,EAA6BC,MAA7B,CAAoC5C,OAAO,CAAC6C,eAAR,CAAwBR,SAAxB,CAApC,CAAvB;EACA,OAAOjC,GAAG,CAAC6B,MAAJ,CAAWQ,cAAX,CAAP;AACD,CALD,C,CAOA;;;AACA,MAAMK,OAAO,GAAGL,cAAc,IAAI;EAChC,MAAMM,MAAM,GAAG3C,GAAG,CAACsC,MAAJ,CAAWD,cAAX,CAAf;EACA,MAAMJ,SAAS,GAAGrC,OAAO,CAACgD,eAAR,CAAwBD,MAAM,CAACJ,KAAP,CAAa,CAAb,EAAgB,CAAhB,CAAxB,CAAlB;EACA,MAAMM,QAAQ,GAAG9C,KAAK,CAACoC,QAAN,CAAeQ,MAAM,CAAC,CAAD,CAArB,CAAjB;EACA,MAAMG,SAAS,GAAGD,QAAQ,GAAG,EAAX,GAAgB,EAAhB,GAAqB,CAAC9C,KAAK,CAACmB,UAAN,CAAiB2B,QAAQ,GAAG,EAAX,IAAiB,CAAlC,CAAD,EAAuC,IAAvC,EAA6C,IAA7C,CAAvC;EACA,MAAMlC,IAAI,GAAGgC,MAAM,CAACJ,KAAP,CAAa,CAAb,EAAgB,CAAhB,EAAmBC,MAAnB,CAA0BM,SAA1B,CAAb;EACA,MAAMC,OAAO,GAAG/C,GAAG,CAAC6B,MAAJ,CAAWlB,IAAX,CAAhB;EACA,OAAOf,OAAO,CAAC8C,OAAR,CAAgBzC,SAAS,CAAC8C,OAAD,CAAzB,EAAoCd,SAApC,CAAP;AACD,CARD;;AAUAe,MAAM,CAACC,OAAP,GAAiB;EACf/C,WADe;EAEf0B,WAFe;EAGfG,IAHe;EAIfW;AAJe,CAAjB"},"metadata":{},"sourceType":"script"}